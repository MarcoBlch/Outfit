#!/bin/bash -e

# If running the rails server then prepare database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  echo "=== Railway Deployment Starting ==="

  # Check if schema_migrations table exists (indicates database is initialized)
  SCHEMA_EXISTS=$(./bin/rails runner "puts ActiveRecord::Base.connection.table_exists?('schema_migrations')" 2>&1 | tail -1)

  if [ "$SCHEMA_EXISTS" == "true" ]; then
    echo "Database initialized, running migrations and post-migrate tasks..."
    ./bin/rails db:migrate 2>&1 || echo "Migrations completed with warnings"
    ./bin/rails db:ensure_id_defaults 2>&1 || echo "ID defaults check completed"
  else
    echo "Empty database, running initial migrations..."
    ./bin/rails db:migrate 2>&1 || echo "Migrations completed"
  fi

  echo "=== Database ready ==="
fi

exec "${@}"
