<div class="h-[calc(100vh-4rem)] flex overflow-hidden" data-controller="canvas"
     <% if @preselected_items.present? %>
     data-canvas-preselected-value="<%= @preselected_items.map { |item| { id: item.id, image_src: url_for(item.image) } }.to_json %>"
     <% end %>>
  <!-- Sidebar: Wardrobe -->
  <aside class="w-80 theme-card border-r theme-border flex flex-col">
    <div class="p-4 border-b theme-border">
      <h2 class="text-lg font-medium theme-text">Wardrobe</h2>
      <p class="text-xs theme-text-secondary">Drag items to the canvas</p>
    </div>

    <!-- Search in sidebar -->
    <div class="p-4 border-b theme-border">
      <div class="relative">
        <input type="text"
               placeholder="Search items..."
               data-canvas-target="search"
               data-action="input->canvas#filterItems"
               class="w-full pl-9 pr-3 py-2 text-sm rounded-lg theme-bg border theme-border theme-text placeholder:theme-text-muted focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 theme-text-muted">
          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        </svg>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-4" data-canvas-target="itemList">
      <% @wardrobe_items.each do |item| %>
        <div
          draggable="true"
          data-action="dragstart->canvas#dragStart"
          data-id="<%= item.id %>"
          data-image-src="<%= url_for(item.image) if item.image.attached? %>"
          data-category="<%= item.category %>"
          class="theme-bg rounded-lg p-2 cursor-grab active:cursor-grabbing hover:bg-gray-100 dark:hover:bg-gray-800 border theme-border transition-colors"
        >
          <% if item.image.attached? %>
            <%= image_tag item.image, class: "w-full h-32 object-contain pointer-events-none rounded bg-white" %>
          <% else %>
             <div class="w-full h-32 flex items-center justify-center theme-text-muted bg-gray-100 dark:bg-gray-800 rounded">
               <span class="text-xs">No Image</span>
             </div>
          <% end %>
          <div class="mt-2 text-xs theme-text-secondary truncate"><%= item.category&.titleize %></div>
        </div>
      <% end %>

      <% if @wardrobe_items.empty? %>
        <div class="text-center py-8">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto theme-text-muted mb-3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6.878V6a2.25 2.25 0 0 1 2.25-2.25h7.5A2.25 2.25 0 0 1 18 6v.878m-12 0c.235-.083.487-.128.75-.128h10.5c.263 0 .515.045.75.128m-12 0A2.25 2.25 0 0 0 4.5 9v.878m13.5-3A2.25 2.25 0 0 1 19.5 9v.878m0 0a2.246 2.246 0 0 0-.75-.128H5.25c-.263 0-.515.045-.75.128m15 0A2.25 2.25 0 0 1 21 12v6a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 18v-6c0-.98.626-1.813 1.5-2.122" />
          </svg>
          <p class="theme-text-secondary text-sm">No items yet</p>
          <%= link_to new_wardrobe_item_path, class: "text-purple-500 hover:text-purple-400 text-sm font-medium mt-2 inline-block" do %>
            Add your first item →
          <% end %>
        </div>
      <% end %>
    </div>
  </aside>

  <!-- Main Canvas Area -->
  <main class="flex-1 flex flex-col relative theme-bg">
    <!-- Toolbar -->
    <div class="h-16 border-b theme-border flex items-center justify-between px-6 theme-card">
      <h1 class="text-xl font-bold theme-text">New Outfit</h1>

      <%= form_with model: @outfit, local: true, class: "flex items-center space-x-4" do |f| %>
        <% if @outfit.errors.any? %>
          <div class="absolute top-16 right-0 bg-red-500 text-white p-2 rounded text-xs z-50">
            <%= @outfit.errors.full_messages.join(", ") %>
          </div>
        <% end %>
        <%= f.label :name, "Outfit Name", class: "sr-only" %>
        <%= f.text_field :name, placeholder: "Outfit Name", class: "bg-transparent border-0 border-b theme-border theme-text placeholder:theme-text-muted focus:ring-0 focus:border-purple-500 px-0" %>

        <!-- Canvas Container for Inputs (populated by JS) -->
        <div data-canvas-target="input"></div>

        <%= f.submit "Save Outfit", class: "px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-purple-600/20" %>
      <% end %>
    </div>

      <!-- Canvas Area -->
      <div class="flex-1 m-4 bg-gray-50 dark:bg-gray-900/50 backdrop-blur-xl rounded-2xl border theme-border p-8 flex flex-col relative overflow-hidden"
           data-canvas-target="canvas">

        <div class="absolute top-4 left-4 z-10 theme-text-muted text-sm pointer-events-none">
          <p>Drag items here from the wardrobe.</p>
          <p class="text-xs mt-1 opacity-70">Tap to select • Drag to move • Pinch/Rotate to adjust</p>
        </div>

        <!-- Items will be dropped here -->

        <!-- Floating Toolbar (Hidden by default) -->
        <div data-canvas-target="toolbar" class="absolute bottom-8 left-1/2 -translate-x-1/2 theme-card border theme-border rounded-full px-4 py-2 flex items-center space-x-4 shadow-2xl z-50 transition-all duration-300 translate-y-20 opacity-0">
          <button type="button" data-action="canvas#bringToFront" class="p-2 theme-text-secondary hover:theme-text hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors" title="Bring to Front" aria-label="Bring to Front">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
          </button>
          <button type="button" data-action="canvas#sendToBack" class="p-2 theme-text-secondary hover:theme-text hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors" title="Send to Back" aria-label="Send to Back">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
          </button>
          <div class="w-px h-6 theme-border"></div>
          <button type="button" data-action="canvas#removeItem" class="p-2 text-red-500 hover:text-red-400 hover:bg-red-500/10 rounded-full transition-colors" title="Remove" aria-label="Remove item">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
          </button>
        </div>
      </div>
  </main>
</div>
