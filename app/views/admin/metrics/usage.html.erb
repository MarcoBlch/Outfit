<% content_for :page_title, "Usage Analytics" %>

<div class="space-y-6">
  <!-- AI Usage KPIs -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <!-- Total AI Suggestions -->
    <div class="glass rounded-xl p-6 hover:shadow-xl transition-all duration-300">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-400">Total AI Suggestions</p>
          <p class="mt-2 text-3xl font-bold text-white"><%= @total_suggestions %></p>
          <p class="mt-2 text-xs text-green-400">+<%= @suggestions_today %> today</p>
        </div>
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- This Month -->
    <div class="glass rounded-xl p-6 hover:shadow-xl transition-all duration-300">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-400">This Month</p>
          <p class="mt-2 text-3xl font-bold text-white"><%= @suggestions_this_month %></p>
          <p class="mt-2 text-xs text-gray-400">Avg <%= (@suggestions_this_month.to_f / Date.current.day).round(1) %>/day</p>
        </div>
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- AI Cost This Month -->
    <div class="glass rounded-xl p-6 hover:shadow-xl transition-all duration-300 <%= @ai_cost_this_month > 500 ? 'ring-2 ring-red-500' : '' %>">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-400">AI Cost This Month</p>
          <p class="mt-2 text-3xl font-bold <%= @ai_cost_this_month > 500 ? 'text-red-400' : 'text-white' %>">
            <%= number_to_currency(@ai_cost_this_month) %>
          </p>
          <p class="mt-2 text-xs text-gray-400">
            Est. <%= number_to_currency(@ai_cost_this_month / @suggestions_this_month, precision: 3) %> per call
          </p>
        </div>
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
      </div>
      <% if @ai_cost_this_month > 500 %>
        <div class="mt-3 text-xs text-red-400 font-medium">
          Warning: Cost exceeds $500 threshold
        </div>
      <% end %>
    </div>

    <!-- Avg per User -->
    <div class="glass rounded-xl p-6 hover:shadow-xl transition-all duration-300">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-400">Avg per User</p>
          <p class="mt-2 text-3xl font-bold text-white"><%= @avg_suggestions_per_user.round(1) %></p>
          <p class="mt-2 text-xs text-gray-400">All-time average</p>
        </div>
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Feature Usage Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Wardrobe Items Uploaded -->
    <div class="glass rounded-xl p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-400">Wardrobe Items</p>
          <p class="mt-2 text-2xl font-bold text-white"><%= @total_wardrobe_items %></p>
          <p class="mt-1 text-xs text-gray-400">+<%= @wardrobe_items_this_week %> this week</p>
        </div>
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Outfits Created -->
    <div class="glass rounded-xl p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-400">Outfits Created</p>
          <p class="mt-2 text-2xl font-bold text-white"><%= @total_outfits %></p>
          <p class="mt-1 text-xs text-gray-400">+<%= @outfits_this_week %> this week</p>
        </div>
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Image Searches (Premium Feature) -->
    <div class="glass rounded-xl p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-400">Image Searches</p>
          <p class="mt-2 text-2xl font-bold text-white"><%= @total_image_searches %></p>
          <p class="mt-1 text-xs text-gray-400">Premium feature</p>
        </div>
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- AI Suggestions Over Time -->
    <div class="glass rounded-xl p-6">
      <h3 class="text-lg font-semibold text-white mb-4">AI Suggestions (Last 30 Days)</h3>
      <%= area_chart @suggestions_over_time,
          library: {
            backgroundColor: 'transparent',
            borderColor: 'rgb(168, 85, 247)',
            tension: 0.4,
            fill: true,
            backgroundColor: 'rgba(168, 85, 247, 0.1)',
            pointBackgroundColor: 'rgb(168, 85, 247)',
            pointBorderColor: '#fff',
            scales: {
              y: {
                ticks: { color: 'rgb(156, 163, 175)' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              },
              x: {
                ticks: { color: 'rgb(156, 163, 175)' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              }
            },
            plugins: {
              legend: { display: false }
            }
          },
          height: "300px"
      %>
    </div>

    <!-- AI Cost Over Time -->
    <div class="glass rounded-xl p-6">
      <h3 class="text-lg font-semibold text-white mb-4">AI Costs (Last 30 Days)</h3>
      <%= line_chart @ai_costs_over_time,
          library: {
            backgroundColor: 'transparent',
            borderColor: 'rgb(234, 179, 8)',
            tension: 0.4,
            fill: true,
            backgroundColor: 'rgba(234, 179, 8, 0.1)',
            pointBackgroundColor: 'rgb(234, 179, 8)',
            pointBorderColor: '#fff',
            scales: {
              y: {
                ticks: { color: 'rgb(156, 163, 175)' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              },
              x: {
                ticks: { color: 'rgb(156, 163, 175)' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              }
            },
            plugins: {
              legend: { display: false }
            }
          },
          prefix: "$",
          height: "300px"
      %>
    </div>
  </div>

  <!-- Usage by Tier -->
  <div class="glass rounded-xl p-6">
    <h3 class="text-lg font-semibold text-white mb-4">AI Usage by Subscription Tier</h3>
    <%= column_chart @usage_by_tier,
        library: {
          backgroundColor: 'transparent',
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              ticks: { color: 'rgb(156, 163, 175)' },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: 'rgb(156, 163, 175)' },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            }
          }
        },
        colors: ['rgb(107, 114, 128)', 'rgb(168, 85, 247)', 'rgb(236, 72, 153)'],
        height: "300px"
    %>
  </div>

  <!-- Top Contexts -->
  <div class="glass rounded-xl p-6">
    <h3 class="text-lg font-semibold text-white mb-4">Top AI Suggestion Contexts</h3>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="border-b border-white/10">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Context</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Count</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">% of Total</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-white/5">
          <% if @top_contexts.any? %>
            <% @top_contexts.each do |context, count| %>
              <tr class="hover:bg-white/5">
                <td class="px-4 py-3 text-white font-medium"><%= context.presence || "No context" %></td>
                <td class="px-4 py-3 text-center text-white"><%= count %></td>
                <td class="px-4 py-3 text-right text-gray-400">
                  <%= number_to_percentage((count.to_f / @total_suggestions * 100), precision: 1) %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="3" class="px-4 py-8 text-center text-gray-400">No data available</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Peak Usage Hours (Heatmap alternative - table view) -->
  <div class="glass rounded-xl p-6">
    <h3 class="text-lg font-semibold text-white mb-4">Peak Usage Hours (Last 7 Days)</h3>
    <div class="grid grid-cols-12 gap-2">
      <% (0..23).each do |hour| %>
        <div class="text-center">
          <div class="text-xs text-gray-400 mb-2"><%= hour.to_s.rjust(2, '0') %></div>
          <% intensity = @hourly_usage[hour].to_f / @hourly_usage.values.max * 100 rescue 0 %>
          <div class="h-16 rounded <%= usage_intensity_color(intensity) %> flex items-end justify-center">
            <span class="text-xs text-white mb-1"><%= @hourly_usage[hour] || 0 %></span>
          </div>
        </div>
      <% end %>
    </div>
    <div class="mt-4 flex items-center justify-center space-x-4 text-xs text-gray-400">
      <div class="flex items-center space-x-2">
        <div class="w-4 h-4 rounded bg-white/10"></div>
        <span>Low</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-4 h-4 rounded bg-primary/50"></div>
        <span>Medium</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-4 h-4 rounded bg-primary"></div>
        <span>High</span>
      </div>
    </div>
  </div>

  <!-- Daily Active Users -->
  <div class="glass rounded-xl p-6">
    <h3 class="text-lg font-semibold text-white mb-4">Daily Active Users (Last 30 Days)</h3>
    <%= line_chart @daily_active_users,
        library: {
          backgroundColor: 'transparent',
          borderColor: 'rgb(34, 197, 94)',
          tension: 0.4,
          fill: true,
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          pointBackgroundColor: 'rgb(34, 197, 94)',
          pointBorderColor: '#fff',
          scales: {
            y: {
              ticks: { color: 'rgb(156, 163, 175)' },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: 'rgb(156, 163, 175)' },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            }
          },
          plugins: {
            legend: { display: false }
          }
        },
        height: "300px"
    %>
  </div>
</div>
