<%# First-time user wizard (shows for new users with no items) %>
<% if current_user.wardrobe_items.empty? && current_user.created_at > 30.days.ago %>
  <%= render "pages/first_time_wizard" %>
<% end %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

  <!-- Trial countdown banner (for users on Premium trial) -->
  <%= render "shared/trial_countdown" %>

  <!-- Personalized Greeting Section -->
  <div class="theme-card theme-border border rounded-2xl p-8 md:p-10 shadow-lg relative overflow-hidden">
    <!-- Decorative gradient background -->
    <div class="absolute top-0 right-0 -mt-20 -mr-20 w-96 h-96 bg-purple-600/10 rounded-full blur-3xl"></div>

    <div class="relative z-10">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <!-- Greeting and stats -->
        <div class="flex-1">
          <h1 class="text-3xl md:text-4xl font-bold theme-text mb-2">
            <%
              hour = Time.current.hour
              greeting = if hour < 12
                "Good morning"
              elsif hour < 18
                "Good afternoon"
              else
                "Good evening"
              end
            %>
            <%= greeting %>, <%= current_user.username %>!
          </h1>
          <p class="theme-text-secondary text-lg">
            You have <%= pluralize(current_user.wardrobe_items.count, 'item') %> in your wardrobe
            <% if current_user.outfits.any? %>
              and <%= pluralize(current_user.outfits.count, 'outfit') %> created.
            <% else %>
              — ready to create your first outfit?
            <% end %>
          </p>
        </div>

        <!-- Weather Display (dynamic based on user location) -->
        <% if current_user.weather_available? %>
          <% weather = current_user.current_weather %>
          <% if weather.present? %>
            <div class="theme-bg rounded-xl p-4 flex items-center space-x-3 min-w-max">
              <div class="w-12 h-12 rounded-full bg-gradient-to-br <%= weather_gradient_class(weather[:condition]) %> flex items-center justify-center">
                <%= weather_icon(weather[:condition]) %>
              </div>
              <div>
                <p class="theme-text font-semibold text-lg"><%= weather[:temp] %>°F</p>
                <p class="theme-text-muted text-xs capitalize"><%= weather[:condition] %></p>
              </div>
            </div>
          <% else %>
            <!-- Weather fetch failed - show placeholder -->
            <div class="theme-bg rounded-xl p-4 flex items-center space-x-3 min-w-max opacity-60">
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-400 to-gray-500 flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                </svg>
              </div>
              <div>
                <p class="theme-text font-semibold text-sm">Weather unavailable</p>
                <p class="theme-text-muted text-xs">Try again later</p>
              </div>
            </div>
          <% end %>
        <% else %>
          <!-- No location set - prompt user to add it -->
          <%= link_to edit_user_profile_path, class: "theme-bg rounded-xl p-4 flex items-center space-x-3 min-w-max hover:ring-2 hover:ring-purple-500/50 transition-all cursor-pointer" do %>
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </div>
            <div>
              <p class="theme-text font-semibold text-sm">Set your location</p>
              <p class="theme-text-muted text-xs">For weather-based outfits</p>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Onboarding Progress (shows until all steps complete) -->
  <%= render "shared/onboarding_progress" %>

  <!-- Ad Banner for Free Tier Users (hidden for first 7 days to let users experience value first) -->
  <% if current_user.free? && current_user.created_at < 7.days.ago %>
    <%= render "shared/ad_banner" %>
  <% end %>

  <!-- Quick Actions Row -->
  <div>
    <h2 class="text-xl font-bold theme-text mb-4">Quick Actions</h2>
    <%= render "pages/quick_actions" %>
  </div>

  <!-- Today's Outfit Suggestion Card -->
  <div>
    <%= render "pages/todays_outfit" %>
  </div>

  <!-- AI Suggestions CTA (for users who haven't used it much) -->
  <% if current_user.outfit_suggestions.count < 3 %>
    <div class="theme-card theme-border border rounded-2xl overflow-hidden hover:shadow-lg transition-all duration-200 relative">
      <div class="relative p-8 md:p-10">
        <!-- Background gradient effect -->
        <div class="absolute top-0 right-0 w-96 h-96 bg-gradient-to-br from-purple-600/20 to-pink-600/20 rounded-full blur-3xl"></div>

        <div class="relative z-10 grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
          <!-- Content -->
          <div class="md:col-span-2 space-y-4">
            <div class="flex items-center space-x-2">
              <div class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
              </div>
              <span class="text-xs font-semibold text-purple-600 uppercase tracking-wider">AI-Powered</span>
            </div>

            <h2 class="text-2xl md:text-3xl font-bold theme-text">
              Get Personalized Outfit Suggestions
            </h2>

            <p class="theme-text-secondary max-w-xl">
              Tell me where you're going, and I'll suggest perfect outfits from your wardrobe in seconds. No more decision fatigue.
            </p>

            <!-- Stats -->
            <div class="flex items-center space-x-6 pt-2">
              <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-sm theme-text-muted">
                  <span class="font-semibold theme-text"><%= current_user.remaining_suggestions_today %></span> suggestions remaining today
                </span>
              </div>

              <% if current_user.outfit_suggestions.completed.any? %>
                <div class="flex items-center space-x-2">
                  <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <span class="text-sm theme-text-muted">
                    <%= current_user.outfit_suggestions.completed.count %> suggestions generated
                  </span>
                </div>
              <% end %>
            </div>
          </div>

          <!-- CTA Buttons -->
          <div class="md:col-span-1 flex flex-col space-y-3">
            <%= link_to new_outfit_suggestion_path,
                data: { turbo_frame: "modal" },
                class: "w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-xl shadow-lg shadow-purple-600/30 hover:shadow-purple-600/50 hover:scale-105 transition-all duration-200 text-center" do %>
              <span class="flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <span>Get AI Suggestions</span>
              </span>
            <% end %>

            <% if current_user.outfit_suggestions.any? %>
              <%= link_to outfit_suggestions_path,
                  class: "w-full px-6 py-3 theme-border border theme-text font-medium rounded-xl hover:bg-purple-600/10 transition-colors text-center" do %>
                View History
              <% end %>
            <% else %>
              <div class="text-center">
                <p class="text-xs theme-text-muted">
                  Try: "job interview at tech startup"
                </p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Turbo Stream subscriptions for real-time updates -->
  <%= turbo_stream_from "user_#{current_user.id}_recent_outfits" %>
  <%= turbo_stream_from "user_#{current_user.id}_recent_items" %>

  <!-- Recent Activity Section -->
  <div>
    <h2 class="text-2xl font-bold theme-text mb-6">Recent Activity</h2>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Recent Outfits -->
      <%= render "pages/recent_outfits", recent_outfits: @recent_outfits %>

      <!-- Recent Items -->
      <%= render "pages/recent_items", recent_items: @recent_items %>
    </div>
  </div>
</div>

<!-- Modal container for Turbo Frame -->
<turbo-frame id="modal"></turbo-frame>
