<%
  # affiliate_product: Hash with product data from Amazon API
  # recommendation: ProductRecommendation instance for analytics tracking
%>

<div class="glass rounded-lg overflow-hidden hover:shadow-xl hover:shadow-purple-600/20 transition-all duration-300 group">
  <!-- Product Image -->
  <div class="aspect-square bg-white/5 relative overflow-hidden">
    <% if affiliate_product['image_url'].present? %>
      <%= image_tag affiliate_product['image_url'],
          alt: affiliate_product['title'],
          class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-300",
          loading: "lazy" %>
    <% else %>
      <div class="w-full h-full flex items-center justify-center">
        <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
      </div>
    <% end %>

    <!-- Rating Badge (if available) -->
    <% if affiliate_product['rating'].present? && affiliate_product['rating'] > 0 %>
      <div class="absolute top-2 right-2">
        <span class="inline-flex items-center px-2 py-1 bg-black/70 backdrop-blur-sm rounded-full text-xs text-yellow-400 font-medium">
          <svg class="w-3 h-3 mr-1 fill-current" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
          </svg>
          <%= number_with_precision(affiliate_product['rating'], precision: 1) %>
        </span>
      </div>
    <% end %>
  </div>

  <!-- Product Details -->
  <div class="p-4 space-y-3">
    <!-- Product Title -->
    <h4 class="text-sm font-medium text-white line-clamp-2 leading-snug">
      <%= affiliate_product['title'] %>
    </h4>

    <!-- Price and Shop Button -->
    <div class="flex items-center justify-between">
      <% if affiliate_product['price'].present? %>
        <div class="space-y-0.5">
          <p class="text-lg font-bold text-white">
            <%= affiliate_product['price'] %>
          </p>
          <% if affiliate_product['original_price'].present? %>
            <p class="text-xs text-gray-500 line-through">
              <%= affiliate_product['original_price'] %>
            </p>
          <% end %>
        </div>
      <% else %>
        <div class="text-sm text-gray-400">
          View on Amazon
        </div>
      <% end %>

      <!-- Shop Now Button with Analytics -->
      <% if affiliate_product['affiliate_url'].present? %>
        <%= link_to affiliate_product['affiliate_url'],
            target: "_blank",
            rel: "noopener noreferrer sponsored",
            class: "px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-sm font-medium rounded-lg hover:shadow-lg hover:shadow-purple-600/40 transition-all duration-200 whitespace-nowrap",
            data: {
              controller: "product-recommendation",
              action: "click->product-recommendation#trackClick",
              product_recommendation_recommendation_id_value: recommendation.id,
              product_recommendation_suggestion_id_value: recommendation.outfit_suggestion_id,
              product_recommendation_product_url_value: affiliate_product['affiliate_url']
            } do %>
          <span class="inline-flex items-center space-x-1">
            <span>Shop Now</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
          </span>
        <% end %>
      <% end %>
    </div>

    <!-- Review Count (if available) -->
    <% if affiliate_product['review_count'].present? && affiliate_product['review_count'] > 0 %>
      <p class="text-xs text-gray-500">
        <%= number_with_delimiter(affiliate_product['review_count']) %> reviews
      </p>
    <% end %>
  </div>
</div>
